{% extends "base.html" %}
{% block title %}Graphs{% endblock %}

{% block content %}
<h1 class="mb-3">Graphs</h1>

<div class="card p-3 shadow-sm mb-3">
  <div class="row g-3">

    <div class="col-md-4">
      <label class="form-label">Mode</label>
      <select id="mode" class="form-select form-select-sm">
        <option value="correlation">Correlation (X vs Y)</option>
        <option value="progression">Progression (one person)</option>
        <option value="bmi_improvement">BMI improvement (people with â‰¥3 checks)</option>
      </select>
    </div>

    <div class="col-md-4 mode-correlation">
      <label class="form-label">X axis</label>
      <select id="xField" class="form-select form-select-sm">
        {% for key,label in numeric_fields %}
          <option value="{{ key }}">{{ label }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-4 mode-correlation">
      <label class="form-label">Y axis</label>
      <select id="yField" class="form-select form-select-sm">
        {% for key,label in numeric_fields %}
          <option value="{{ key }}">{{ label }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-6 mode-progression" style="display:none;">
      <label class="form-label">Person</label>
      <select id="personKey" class="form-select form-select-sm">
        {% for key,label in people_choices %}
          <option value="{{ key }}">{{ label }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-6 mode-progression" style="display:none;">
      <label class="form-label">Metric</label>
      <select id="metric" class="form-select form-select-sm">
        {% for key,label in numeric_fields %}
          <option value="{{ key }}">{{ label }}</option>
        {% endfor %}
      </select>
    </div>

  </div>

  <div class="mt-3 d-flex gap-2">
    <button class="btn btn-sm btn-primary" id="renderBtn">Render</button>
    <span class="text-muted" id="status" style="font-size:12px;"></span>
  </div>
</div>

<div class="card p-3 shadow-sm">
  <canvas id="chart" height="120"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
  let chart = null;

  function showModeUI() {
    const mode = document.getElementById("mode").value;

    document.querySelectorAll(".mode-correlation").forEach(el => {
      el.style.display = (mode === "correlation") ? "" : "none";
    });
    document.querySelectorAll(".mode-progression").forEach(el => {
      el.style.display = (mode === "progression") ? "" : "none";
    });
  }

  async function renderChart() {
    const mode = document.getElementById("mode").value;
    const status = document.getElementById("status");
    status.textContent = "Loading...";

    const params = new URLSearchParams({ mode });

    if (mode === "correlation") {
      params.set("x", document.getElementById("xField").value);
      params.set("y", document.getElementById("yField").value);
    }

    if (mode === "progression") {
      params.set("person", document.getElementById("personKey").value);
      params.set("metric", document.getElementById("metric").value);
    }

    const res = await fetch("{% url 'graphs_data' %}?" + params.toString());
    const data = await res.json();

    if (!data.ok) {
      status.textContent = data.error || "Error";
      return;
    }

    status.textContent = "";

    const ctx = document.getElementById("chart").getContext("2d");
    if (chart) chart.destroy();

    if (mode === "correlation") {
      chart = new Chart(ctx, {
        type: "scatter",
        data: {
          datasets: data.series.map(s => ({
            label: s.label,
            data: s.points
          }))
        },
        options: {
          responsive: true,
          plugins: { legend: { display: true } },
          scales: {
            x: { title: { display: true, text: "X" } },
            y: { title: { display: true, text: "Y" } }
          }
        }
      });
      return;
    }

    if (mode === "progression") {
      chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: data.labels,
          datasets: data.series.map(s => ({
            label: s.label,
            data: s.data,
            tension: 0.2
          }))
        },
        options: {
          responsive: true,
          plugins: { legend: { display: true } }
        }
      });
      return;
    }

    if (mode === "bmi_improvement") {
      // Bar chart: each person bar = delta (last-first)
      const pts = data.series[0].points;
      const labels = pts.map(p => p.person);
      const deltas = pts.map(p => p.delta);

      chart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: labels,
          datasets: [{
            label: data.series[0].label,
            data: deltas
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: true } },
          scales: {
            x: { ticks: { maxRotation: 90, minRotation: 45 } },
          }
        }
      });
      return;
    }
  }

  document.getElementById("mode").addEventListener("change", () => {
    showModeUI();
  });

  document.getElementById("renderBtn").addEventListener("click", (e) => {
    e.preventDefault();
    renderChart();
  });

  showModeUI();
</script>
{% endblock %}
