{% extends "base.html" %}
{% block title %}Question Builder{% endblock %}

{% block content %}
<h1 class="mb-1">Questions: {{ form_def.name }}</h1>
<p class="text-muted mb-3">Drag and drop to reorder questions.</p>

{# Ensure CSRF cookie exists for fetch() #}
<form style="display:none;">{% csrf_token %}</form>

<div id="fields-list">
  {% for field in fields %}
    <div class="card mb-2" data-field-id="{{ field.id }}">
      <div class="card-body d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center gap-2">
          <span class="drag-handle" style="cursor:grab; user-select:none;">â˜°</span>
          <div>
            <strong>{{ field.label }}</strong>
            {% if field.required %}<span class="text-danger">*</span>{% endif %}
            <span class="text-muted">({{ field.get_field_type_display }})</span>
          </div>
        </div>

        <div class="d-flex gap-2">
          <a class="btn btn-sm btn-outline-primary" href="{% url 'question_edit' form_def.id field.id %}">Edit</a>
          <a class="btn btn-sm btn-outline-danger" href="{% url 'question_delete' form_def.id field.id %}">Delete</a>
        </div>
      </div>
    </div>
  {% empty %}
    <div class="alert alert-info">No questions yet.</div>
  {% endfor %}
</div>

<div class="mt-3">
  <a class="btn btn-primary btn-sm" href="{% url 'question_add' form_def.id %}">
    + Add Question
  </a>
</div>


<hr class="my-4">

<div class="d-flex gap-2">
  <a class="btn btn-sm btn-outline-secondary" href="{% url 'forms_page' %}">Back to Forms</a>
  <a class="btn btn-sm btn-outline-primary" href="{% url 'form_fill' form_def.id %}">Preview / Fill</a>
  <a class="btn btn-sm btn-outline-success" href="{% url 'form_results' form_def.id %}">Results</a>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

<script>
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + "=")) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function initSortable() {
    const el = document.getElementById("fields-list");
    if (!el) return;

    if (typeof Sortable === "undefined") {
      console.log("SortableJS not loaded");
      return;
    }

    // Prevent double init
    if (el.dataset.sortableInit === "1") return;
    el.dataset.sortableInit = "1";

    new Sortable(el, {
      animation: 150,
      handle: ".drag-handle",
      onEnd: async function () {
        const ids = Array.from(el.querySelectorAll("[data-field-id]"))
          .map(x => x.getAttribute("data-field-id"));

        try {
          const res = await fetch("{% url 'fields_reorder' form_def.id %}", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": getCookie("csrftoken"),
            },
            body: JSON.stringify({ ids: ids }),
          });

          if (!res.ok) {
            const txt = await res.text();
            console.log("Reorder failed:", res.status, txt);
          } else {
            console.log("Reorder OK");
          }
        } catch (e) {
          console.log("Reorder error:", e);
        }
      },
    });
  }

  document.addEventListener("DOMContentLoaded", initSortable);

  // If you use HTMX later, this keeps it working after swaps:
  document.body.addEventListener("htmx:afterSwap", function () {
    const el = document.getElementById("fields-list");
    if (el) el.dataset.sortableInit = "0";
    initSortable();
  });
</script>

{% endblock %}
